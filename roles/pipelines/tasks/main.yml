- name: create temporary kubeflow src dir
  file: path="{{ pipelines.kubeflow_src }}" state=directory

- name: get PATH
  shell: echo $PATH
  register: path

- name: download ks
  include: ks.yml

- name: download kubectl
  include: kubectl.yml

- name: download download.sh
  get_url: url=https://raw.githubusercontent.com/kubeflow/kubeflow/master/scripts/download.sh
           dest={{ pipelines.kubeflow_src }}/download.sh

- name: exec download.sh to download kfctl.sh
  shell: |
    cd {{ pipelines.kubeflow_src }}
    bash download.sh

- name: hack to update a couple of files
  shell: |
    cd {{ pipelines.kubeflow_src }}
    cp -f /opt/ansible/patched/argo.libsonnet kubeflow/argo
    cp -f /opt/ansible/patched/argo.jsonnet kubeflow/argo/prototypes
    cp -f /opt/ansible/patched/pipeline-apiserver.libsonnet kubeflow/pipeline

- name: set up and generate k8s application
  ignore_errors: yes
  environment:
    DEFAULT_KUBEFLOW_COMPONENTS: "{{ pipelines.components }}"
    K8S_NAMESPACE: "{{ pipelines.namespace }}"
    PATH: "{{ path.stdout }}:/opt/ansible"
  shell: |
    cd {{ pipelines.kubeflow_src }}
    scripts/kfctl.sh init kfapp --platform none
    cd kfapp
    ../scripts/kfctl.sh generate k8s

- name: hack to set up specific environment etc
  environment:
    DEFAULT_KUBEFLOW_COMPONENTS: "{{ pipelines.components }}"
    PATH: "{{ path.stdout }}:/opt/ansible"
  shell: |
    cd {{ pipelines.kubeflow_src }}/kfapp/ks_app
    ks param set ambassador ambassadorServiceType NodePort
    ks param set argo containerRuntimeExecutor k8sapi
    ks param set argo executorImage tomcli/argoexec:containerd
    ks param set argo workflowControllerImage tomcli/workflow-controller:containerd

- name: deploy kubeflow pipelines service
  ignore_errors: yes
  environment:
    DEFAULT_KUBEFLOW_COMPONENTS: "{{ pipelines.components }}"
    PATH: "{{ path.stdout }}:/opt/ansible"
  shell: |
    cd {{ pipelines.kubeflow_src }}/kfapp
    ../scripts/kfctl.sh apply k8s

- name: wait for service running
  environment:
    PATH: "{{ path.stdout }}:/opt/ansible"
  shell: |
    state=""
    retries=0
    while [ "$state" != "Running" -a $retries -lt 300 ]
    do
        sleep 2
        retries=`expr $retries + 1`
        state=$(kubectl get pods -o=jsonpath='{range .items[*]}{.status.phase}{"\n"}{end}' -n {{ pipelines.namespace }} |uniq)
    done
